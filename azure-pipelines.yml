trigger:
  - main

pool:
  vmImage: windows-2022

steps:
- powershell: | 

        @"%SystemRoot%\System32\WindowsPowerShell\v1.0\powershell.exe" -NoProfile -InputFormat None -ExecutionPolicy Bypass -Command "[System.Net.ServicePointManager]::SecurityProtocol = 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))" && SET "PATH=%PATH%;%ALLUSERSPROFILE%\chocolatey\bin"
        Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
  
  displayName: 'Installing  Chocolatery'

- powershell: | 
       
  displayName: 'Installing  .net core framework'

- powershell: | 
          choco install azure-cli
          choco install git
          winget install Microsoft.DotNet.SDK.Preview  

  displayName: 'Installing  Rest of dependencies'

- powershell: | 
      
          winget install Microsoft.DotNet.SDK.Preview  
             
  displayName: 'Installing  .net 7'

- powershell: | 

          az login --service-principal -u e86f1bfa-58b0-47f2-9dac-6f61de199e08 -p gw88Q~N1Udw_fEEkpneMtwb3idoZhkK2bnywWbMP --tenant 8af79369-0252-4816-893a-d143b54885e3

  displayName: 'Login to Azure cli using Service principal '

          

- powershell: | 

            dotnet restore aspnetcoreapp.csproj --packages .nuget/ --runtime win-x86
            dotnet publish aspnetcoreapp.csproj -c Release --no-restore --runtime win-x86 --no-self-contained -o ./tmp/publish
            cd tmp\publish
            Compress-Archive . publish.zip

  displayName: 'Building Application '



- powershell: | 

          az webapp deploy --resource-group mm --name mm-skedda-app-webapp60126-eastus --src-path publish.zip --type zip

  displayName: 'Deploying Application to Azure'
